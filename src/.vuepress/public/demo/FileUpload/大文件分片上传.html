<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>大文件分片上传 DEMO</title>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script>
  </head>
  <body>
    <div>
      <input type="file" name="file" id="file" multiple />
      <button id="upload" onClick="uploadChunks()">上传</button>
    </div>
    <script>
      /**
       * @description: 封装fetch
       * @param {Object} FetchConfig fetch config
       * @return {Promise} fetch result
       */
      const requestApi = ({ url, method = "GET", ...fetchProps }) => {
        return (
          fetch(url, {
            method,
            ...fetchProps,
          })
            //返回请求成功的结果
            .then((res) => res && res.status === 200 && res.json())
            // .catch((err) => alert("未知错误", err))
            .then((res) => res)
        );
      };

      // 文件分片
      const createFileChunk = (file) => {
        const fileSize = file.size; // 文件大小
        const chunkList = [];
        //计算文件切片总数
        const sliceSize = 5 * 1024 * 1024; // 每个文件切片大小定为5MB
        const totalSlice = Math.ceil(fileSize / sliceSize);
        for (let i = 1; i <= totalSlice; i++) {
          let chunk;
          if (i == totalSlice) {
            // 最后一片
            chunk = file.slice((i - 1) * sliceSize, fileSize - 1); //切割文件
          } else {
            chunk = file.slice((i - 1) * sliceSize, i * sliceSize);
          }
          chunkList.push({ file: chunk, fileSize });
        }
        return chunkList;
      };

      //上传分片
      const uploadChunks = async () => {
        const file = document.getElementById("file").files[0];
        const fileName = file.name; // 文件名
        const fileHash = md5(file); // 文件hash
        const fileChunkList = createFileChunk(file);
        const { shouldUpload } = await verifyUpload(fileName, fileHash);
        if (!shouldUpload) {
          alert("秒传：上传成功");
          return;
        }
        const requestList = fileChunkList
          .map(({ file, fileSize }, index) => {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("fileHash", fileHash);
            formData.append("name", fileName);
            formData.append("size", fileSize);
            formData.append("hash", `${fileHash}-${index}`);
            return { formData };
          })
          .map(async ({ formData }) => {
            await requestApi({
              url: `http://localhost:3000`,
              method: "POST",
              body: formData,
            });
          });
        await Promise.all(requestList);
        await mergeRequest(fileName, fileHash);
      };

      // 合并分片
      const mergeRequest = async (fileName, fileHash) => {
        await requestApi({
          url: "http://localhost:3000/merge",
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=utf-8",
          },
          body: JSON.stringify({
            filename: fileName,
            fileHash,
          }),
        });
      };

      //文件秒传
      const verifyUpload = async (filename, fileHash) => {
        const data = await requestApi({
          url: "http://localhost:3000/verify",
          method: "POST",
          headers: {
            "Content-Type": "application/json;charset=utf-8",
          },
          body: JSON.stringify({
            filename,
            fileHash,
          }),
        });
        return data;
      };
    </script>
  </body>
</html>
